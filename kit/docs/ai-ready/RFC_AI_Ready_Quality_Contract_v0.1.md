# RFC: AI‑Ready Contribution Quality Contract (Draft v0.1)

**Repository:** Hyperprompt (и любые репозитории, принимающие этот контракт)  
**Status:** Draft  
**Audience:** maintainers, reviewers, contributors (humans & agent‑runners)  
**Goal:** обеспечить воспроизводимый, безопасный и аудируемый вклад (PR) при массовом контрибьюте, включая автономных агентов.

---

## 1. Декларация намерений

Мы хотим, чтобы любой контрибьютор (человек или агент, запускаемый человеком) мог:

1) выбрать задачу из план‑файла в репозитории;  
2) подготовить PR, который **объективно** проходит набор гейтов качества;  
3) получить понятный фидбэк (CI/ревью) и довести PR до состояния “не стыдно показать человеку”.

При этом репозиторий должен оставаться защищённым от:

- «подмены судьи» (ослабление CI / правил мержа внутри того же PR),
- «подмены постановки» (изменение source‑of‑truth для задач под удобный результат),
- поставки регрессий и деградации качества под видом “зелёного CI”.

---

## 2. Термины и сущности

### 2.1. Source of Truth (SoT)
**`specs/`** — директория источника правды:
- `specs/workplan.md` — план работ / задачи (с ID, фазами, deps, приоритетами).
- `specs/requirements/*` (или аналоги) — продуктовые требования, из которых выведен WorkPlan.

### 2.2. Судья (Judge Surface)
Файлы, определяющие правила проверки/мержа и безопасность CI:
- `.github/workflows/**`
- конфиги линтеров/форматтеров/coverage/perf‑гейтов
- скрипты CI, policy‑настройки, release‑pipeline

### 2.3. Исполнение (Implementation Surface)
Код, тесты, примеры, документация, артефакты, относящиеся к реализации задач:
- `Sources/**`, `Tests/**`, `Docs/**`, `Examples/**`, и т.п.

### 2.4. Типы PR
- **Implementation PR** — реализация конкретной задачи WorkPlan.
- **Spec‑Change PR** — изменение `specs/` (постановки/плана/требований).
- **Judge‑Change PR** — изменение “судьи” (workflow/policy/CI scripts).

> Важное правило: **Implementation PR не должен менять SoT и Судью** (кроме специально разрешённых случаев).

---

## 3. Роли и полномочия

- **Maintainers** — владельцы репозитория, принимают решения о мерже.
- **Product Owner (PO)** — владелец SoT: принимает изменения `specs/`.
- **Infra Owner (IO)** — владелец Judge Surface: принимает изменения CI/policy.
- **Contributor** — любой автор PR (человек) и/или его агент‑раннер.

Минимальная практическая модель для маленького проекта: PO=Maintainer, IO=Maintainer.

---

## 4. Контракт качества PR: обязательные гейты

Ниже перечислены гейты, которые должны выполняться **для каждого PR**, и объясняется, какое правило каждый гейт реализует и зачем он нужен.

### Gate 0 — Traceability / Привязка к задаче
**Правило:** каждый Implementation PR должен ссылаться на **одну** задачу WorkPlan по стабильному ID.

**Требования:**
- В заголовке PR: `[<TASK-ID>] <короткое описание>`
- В теле PR: ссылка на строку/секцию в `specs/workplan.md` + чеклист DoD/AC (если есть)
- Ветка (рекомендация): `task/<TASK-ID>-<slug>`

**Зачем:** аудит, автоматизация, лидерборды, однозначная связь “задача → PR”.

---

### Gate 1 — Protected Paths (SoT / Judge)
**Правило:** контрибьютор не может менять **истину** (SoT) или **судью** (Judge) в Implementation PR.

**Требования:**
- Implementation PR: **запрещены** изменения в `specs/**` и `.github/workflows/**` (и в любых policy‑конфигах), кроме явно разрешённых исключений (см. ниже).
- Любое изменение SoT ⇒ PR должен быть **Spec‑Change PR** и пройти PO‑аппрув.
- Любое изменение Judge ⇒ PR должен быть **Judge‑Change PR** и пройти IO‑аппрув.

**Зачем:** античит. Нельзя “подкрутить правила игры” или “переписать задачу под результат”.

**Исключение (опционально):** если вы выделили в `specs/workplan.md` отдельную “Execution” секцию, разрешено менять **только её**, и только при наличии метки `execution-log` (или аналогичной).

---

### Gate 2 — No Weakening of Quality Gates
**Правило:** нельзя ослаблять проверки качества “в обход”.

**Требования:**
- Запрещено: понижение coverage thresholds, выключение тестов, добавление широких ignore/allowlist без явного согласия PO/IO.
- Если изменение действительно нужно, оно проходит как **Judge‑Change PR** (IO‑review) или **Spec‑Change PR** (PO‑review), в зависимости от сути.

**Зачем:** закрывает обходные лазейки, даже если формально файлы workflow не тронули.

---

### Gate 3 — Reproducible Verification
**Правило:** PR должен быть воспроизводим: команды проверки понятны и выполняются.

**Требования:**
- В PR body обязательна секция **Verification** с командами (copy‑paste).
- CI должен выполнять те же команды (или их супермножество).
- Запрещены “works on my machine” без конкретных шагов.

**Зачем:** ускоряет ревью и снижает вероятность скрытых дефектов.

---

### Gate 4 — Test Suite Green (Unit/Integration)
**Правило:** основной тестовый набор должен проходить.

**Требования:**
- Все обязательные status checks зелёные.
- Тесты должны быть детерминированными (без флаков, или с явной изоляцией).

**Зачем:** базовый safety‑net.

---

### Gate 5 — Diff Coverage (или Changed‑Lines Coverage)
**Правило:** если меняем поведение, мы покрываем изменения тестами; покрытие на изменённых строках не падает.

**Требования:**
- Не допускается падение diff coverage ниже порога (например, 90–95%).
- (Опционально) общий coverage ≥ целевого значения.

**Зачем:** лучше ловит “подогнал тесты под баг”, чем общий coverage‑порог.

---

### Gate 6 — Test Integrity (если меняли тесты)
**Правило:** изменение тестов — потенциально риск “подгонки”; оно должно быть видимым и обоснованным.

**Требования:**
- Если PR меняет `Tests/**`:
  - требуется метка `tests-change`;
  - в PR body обязательна секция **Test Changes Rationale**;
  - (опционально) CODEOWNERS‑аппрув владельца тестов.

**Зачем:** повышает прозрачность и снижает шанс скрытых регрессий.

---

### Gate 7 — Performance/Regression Guard (если применимо)
**Правило:** не ухудшаем критические метрики без явного согласия.

**Требования:**
- Если есть perf workflow: PR не должен превышать регрессионные пороги.
- Регрессии допускаются только с меткой `perf-accepted` и явным обоснованием.

**Зачем:** независимый гейт, который сложнее “обмануть тестами”.

---

### Gate 8 — Dependency & Supply‑Chain Guard
**Правило:** новые зависимости и обновления версий требуют дисциплины.

**Требования:**
- Любые изменения `Package.swift`, lock‑файлов, tooling версий:
  - метка `deps-change`,
  - секция **Dependency Rationale**,
  - (опционально) security/license check.

**Зачем:** снижает риски лицензий/безопасности/вендор‑локинга.

---

### Gate 9 — Danger Zones Require Human
**Правило:** изменения публичного API / форматов / совместимости требуют человека.

**Требования:**
- Если PR меняет публичный API или форматы (в проектной терминологии):
  - метка `api-change` или `format-change`,
  - обязательный аппрув maintainer’а,
  - обновление документации/миграционных заметок (если нужно).

**Зачем:** агент может сделать “работает”, но плохой дизайн/контракт.

---

## 5. Политика по изменению `specs/` (SoT)

### 5.1. Spec‑Change PR
**Назначение:** любые правки WorkPlan или требований.

**Требования:**
- Обязательный аппрув PO.
- Явная мотивация: “зачем меняем постановку”.
- Запрещено совмещать с большим implementation diff (рекомендуется отдельный PR).

**Разрешено агенту:** предлагать Spec‑Change PR, но не переводить задачу в “ready” без PO‑аппрува.

### 5.2. Исполнение статусов задач
Рекомендуемый принцип: **агент предлагает, человек утверждает**.
- `draft → ready` — только PO/maintainer.
- `ready → claimed/in-progress/in-review` — может отражаться в PR/issue/Execution log.
- `done` — фиксируется при мерже соответствующего PR.

---

## 6. Политика по изменению “Судьи” (Judge Surface)

### 6.1. Judge‑Change PR
**Назначение:** изменения CI/workflows/quality‑policy.

**Требования:**
- Обязательный аппрув IO.
- Пояснение, какие гейты меняются и почему.
- Нельзя менять гейты “в сторону ослабления” без явного согласия maintainers.

---

## 7. Минимальные требования к оформлению PR (Template)

Implementation PR должен содержать:

- **Task:** TASK‑ID + ссылка на `specs/workplan.md`
- **What changed:** кратко по сути
- **Why:** мотивация/контекст
- **Verification:** команды
- **Test Changes Rationale:** если менялись тесты
- **Risk/Notes:** что могло пойти не так

---

## 8. Набор меток (Labels) — рекомендуемый минимум

- `agent-ready` — задача сформулирована для автономного исполнения
- `needs-human` — требуется дизайн/решение человека
- `blocked` — есть блокер
- `ai-claimed` — задача взята агентом/контрибьютором
- `tests-change`, `deps-change`, `api-change`, `format-change`
- `spec-change`, `judge-change`
- `execution-log`, `perf-accepted`

---

## 9. Что будет описано далее (следующий RFC)

Этот документ фиксирует **качество PR** и гейты.

Следующий шаг — описать **workflow‑цикл разработки** и синхронизацию с GitHub Issues:
- как задачи из `specs/workplan.md` материализуются в issues,
- как issue становится `agent-ready`,
- как происходит claim,
- как агент получает фидбэк (checks/comments) и дожимает PR,
- как закрываются issues и обновляются статусы в WorkPlan.

---

## 10. Non‑Goals (чего этот RFC не решает)

- реализация конкретных скриптов и actions (код вне рамок v0.1)
- экономика вознаграждений и лидерборды
- выбор конкретных LLM‑инструментов/провайдеров

---

## 11. Примечание о “AI‑ready” как бейдже

Большая часть правил выше — это зрелая open‑source практика.
“AI‑ready” в нашем контексте означает:
1) наличие формального контракта (этого RFC + AGENTS.md/PR templates),
2) наличие защищённых поверхностей (SoT/Judge),
3) наличие машинно‑проверяемых гейтов, достаточных для автономных PR.
