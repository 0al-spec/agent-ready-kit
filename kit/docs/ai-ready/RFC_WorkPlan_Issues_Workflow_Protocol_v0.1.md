# RFC: WorkPlan ↔ Issues Workflow Protocol (Draft v0.1)

**Repository:** Hyperprompt (и любые репозитории, принимающие этот протокол)  
**Status:** Draft  
**Audience:** maintainers, contributors, agent-runners  
**Goal:** описать цикл разработки и синхронизацию задач между offline-first WorkPlan в репозитории и GitHub Issues/PR/CI.

---

## 1. Декларация намерений

Этот протокол делает `WorkPlan` источником правды (source of truth) и использует GitHub Issues как витрину, очередь и control plane для событий (claim, обсуждение, ссылки на PR, статусы CI).

Мы хотим получать следующий эффект: задачи и требования можно читать и редактировать офлайн через PR в репозиторий, а исполнение и обратная связь живут в PR и CI, где агент или человек может итеративно довести изменения до состояния “зелёное и ревью-готово”.

---

## 2. Пути и источник правды

Источник правды хранится в репозитории и обязательно включает WorkPlan и требования. Конкретный путь должен быть единым для проекта, но протокол допускает оба варианта, если один объявлен каноничным:

Каноничный вариант A: `DOCS/Workplan.md` и связанные документы в `DOCS/PRD/**` и `DOCS/INPROGRESS/**`.  
Каноничный вариант B: `specs/workplan.md` и связанные документы в `specs/requirements/**`.

Во всех случаях требования и план меняются только через PR в репозиторий.

---

## 3. Основные сущности

Task — задача из WorkPlan, содержащая стабильный уникальный `TASK_ID`, приоритет, стадию/фазу, зависимости, краткое описание и (желательно) acceptance criteria и definition of done.

Issue — материализация Task на GitHub. Issue не является источником требований. Issue хранит ссылку на Task в WorkPlan и отражает операционное состояние исполнения.

PR — единица исполнения. Один PR привязан к одному `TASK_ID`. PR является местом обратной связи: checks, логи CI, ревью-комментарии, запросы на изменения.

CI — набор обязательных статус-проверок, которые реализуют гейты качества и безопасности.

---

## 4. Принцип синхронизации

Синхронизация считается однонаправленной по требованиям и двунаправленной по операционным фактам.

WorkPlan → Issues: создаём и обновляем issues на основе Task, включая заголовок, описание, ссылки, лейблы и текущее состояние.  
Issues → WorkPlan: требования и постановка не синхронизируются обратно. Допускается синхронизация только фактов исполнения, и то в строго ограниченной форме, описанной ниже.

Это устраняет ситуацию “два редактора одной правды”.

---

## 5. Модель прав и полномочий

Maintainers принимают решения о мерже PR.

Product Owner (PO) владеет требованиями и WorkPlan. В малом проекте это обычно те же maintainers.

Infra Owner (IO) владеет CI и правилами “судьи”. В малом проекте это обычно те же maintainers.

Contributor или agent-runner может предлагать изменения и открывать PR, но не может утверждать изменения источника правды без аппрува PO/maintainer.

---

## 6. Состояния задач и событийная модель

Task имеет каноничное состояние, отражаемое в WorkPlan и/или вычисляемое по событиям в GitHub.

Рекомендуемые состояния: `draft`, `ready`, `claimed`, `in-progress`, `in-review`, `blocked`, `done`.

Рекомендуемые события: `sync_upsert_issue`, `claim`, `unclaim`, `pr_opened`, `ci_failed`, `ci_green`, `changes_requested`, `approved`, `merged`.

Переход `draft → ready` выполняется только PO/maintainer через PR в WorkPlan. Переход в `done` фиксируется только фактом merge соответствующего PR.

Ниже пример конечного автомата (порядок отражает типичный путь, но допускает возвраты по результатам CI/ревью):

```
draft -> ready -> claimed -> in-progress -> in-review -> done
                    |          |             |
                 blocked <-----+-------------+
```

---

## 7. Правило “один PR = одна задача”

Implementation PR обязан быть привязан к единственному `TASK_ID`. Заголовок PR и его описание должны содержать `TASK_ID` и ссылку на конкретную секцию WorkPlan.

Эта привязка является обязательным гейтом трассируемости и нужна для автоматизации, аудита и начисления вклада.

---

## 8. Структура Issue (канонический формат)

Issue по задаче должен содержать:

Поле Task ID: стабильный `TASK_ID` и ссылка на соответствующую задачу в WorkPlan.  
Поле Summary: краткое описание задачи, достаточное, чтобы понять суть без открытия WorkPlan.  
Поле Acceptance/DoD: краткая копия критериев, если они есть в WorkPlan/PRD.  
Поле Constraints: ограничения “что трогать нельзя”, ссылка на контракт качества PR и AGENTS/FLOW.  
Поле Verification: ссылка на каноничные команды проверки (обычно в EXECUTE/AGENTS).

Issue допускает живую дискуссию, но любые изменения требований фиксируются PR’ом в WorkPlan/PRD.

---

## 9. Лейблы и статусы (минимальный набор)

Лейблы используются как сигнал control plane и для маршрутизации.

Для задач: `agent-ready`, `needs-human`, `blocked`, `ai-claimed`.  
Для PR: `tests-change`, `deps-change`, `api-change`, `format-change`, `spec-change`, `judge-change`.  
Для исключений: `perf-accepted`, `execution-log`.

---

## 10. Claim-протокол

Claim нужен, чтобы избегать конфликтов и двойной работы.

Claim выполняется на Issue через комментарий-команду `/claim` либо через установку лейбла `ai-claimed` (один из вариантов выбирается как каноничный для репозитория). Claim должен фиксировать исполнителя, например через ссылку на пользователя GitHub, и опционально указание инструмента, если это важно (например “generated by <tool>”).

Unclaim выполняется через `/unclaim` или снятие лейбла. Claim не меняет требований.

Claim переводит задачу в `claimed` и разрешает открытие PR.

---

## 11. Протокол открытия PR

PR открывается из ветки, содержащей `TASK_ID` в имени. PR title и body содержат `TASK_ID`. PR body содержит секцию Verification с командами проверки, секцию Risk/Notes и при необходимости секции для изменений тестов и зависимостей.

PR является основным каналом обратной связи для агента и человека: checks, CI logs, review comments и approval status.

---

## 12. Feedback loop для автономной доводки

Исполнитель, включая agent-runner, обязан итеративно доводить PR до состояния “merge-ready”.

Merge-ready означает: все required checks зелёные, нет активных “changes requested”, выполнены гейты качества из контракта репозитория, PR оформлен по шаблону и содержит воспроизводимые команды проверки.

Цикл выглядит как: push изменений, ожидание CI, анализ падений, исправление, повтор. После появления ревью-комментариев цикл продолжается с учётом requested changes до полного согласия.

---

## 13. Закрытие задач и архивирование

Задача считается `done` только после merge PR, который привязан к `TASK_ID`.

Issue закрывается автоматически по событию merge или вручную maintainer’ом, если задача отменена или заменена.

WorkPlan обновляется через PR, фиксируя `done` и добавляя ссылку на merged PR. Документы `DOCS/INPROGRESS/**` по задаче переносятся в архивную директорию (например `DOCS/TASKS_ARCHIVE/**`) согласно текущему FLOW.

---

## 14. Ограничение на изменение источника правды и “судьи”

Implementation PR не должен менять WorkPlan и требования, а также не должен менять CI/workflows и policy-конфиги.

Если изменения в WorkPlan или требования действительно нужны, они оформляются отдельным Spec-Change PR и требуют PO/maintainer approval.

Если изменения в CI/workflows действительно нужны, они оформляются отдельным Judge-Change PR и требуют IO/maintainer approval.

Опциональная практика для удобства: вынести операционные отметки исполнения в отдельный файл, например `DOCS/Workplan.execution.md`, чтобы Implementation PR не трогал основной WorkPlan вообще.

---

## 15. Встраивание в текущий FLOW

Текущий FLOW остаётся каноничным локальным циклом. Протокол добавляет мосты к GitHub, не ломая существующие команды.

Рекомендуемое расширение: добавить шаг SYNC перед SELECT, добавить шаг CLAIM после SELECT, а внутри EXECUTE явно включить feedback loop, ориентированный на required checks и ревью в PR.

---

## 16. Non-Goals

Этот RFC не описывает конкретную реализацию скриптов синхронизации, не выбирает конкретные Actions или инструменты агентов и не описывает экономику вознаграждений.

---

## 17. Следующие документы

Следующим документом должен стать “Issue Sync Spec”, где будет зафиксировано, как именно парсятся задачи из WorkPlan, как генерируется заголовок и тело issue, какие лейблы ставятся по состояниям, и какие поля считаются неизменяемыми.

