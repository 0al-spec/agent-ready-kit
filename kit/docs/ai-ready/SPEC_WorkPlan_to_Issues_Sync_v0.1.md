# SPEC: WorkPlan → GitHub Issues Sync (Draft v0.1)

**Repository:** Hyperprompt (и любые репозитории, принимающие этот spec)  
**Status:** Draft  
**Audience:** maintainers, contributors, agent-runners, tooling authors  
**Goal:** строго определить, как задачи из `DOCS/Workplan.md` (или `specs/workplan.md`) материализуются в GitHub Issues, и какие поля/правила считаются неизменяемыми.

---

## 0. Контекст

Этот документ — недостающее звено между:

- `RFC_AI_Ready_Quality_Contract_v0.1.md` (гейты качества PR)  
- `RFC_WorkPlan_Issues_Workflow_Protocol_v0.1.md` (workflow и состояния)

Здесь фиксируется **детерминированная** синхронизация WorkPlan → Issues (upsert), чтобы избежать ручного дрейфа, и чтобы любые агент-раннеры могли одинаково интерпретировать “очередь задач”.

---

## 1. Принципы

1) **Source of Truth:** требования и формулировка задач живут в WorkPlan/PRD в репозитории.  
2) **Issues как зеркало:** issues предназначены для очереди, обсуждения и control plane (claim/links), но не для редактирования требований.  
3) **Idempotency:** синк обязан быть идемпотентным: повторный запуск не порождает дублей и приводит issues к каноническому виду.  
4) **Immutable anchors:** `TASK_ID` и ссылка на WorkPlan являются якорями и **никогда не меняются** при апдейтах.  
5) **Minimize writes:** синк изменяет issue только если вычисленный канонический контент отличается (чтобы не спамить апдейтами).  
6) **Safe-by-default:** синк не закрывает issues “по догадке”; закрытие привязано к merge соответствующего PR или явному статусу `done` в WorkPlan.

---

## 2. Каноничные пути

Синк обязан знать один каноничный путь WorkPlan. Допускаются два варианта, но репозиторий обязан выбрать **один** и зафиксировать его в конфиге синка:

- `DOCS/Workplan.md`  
- `specs/workplan.md`

---

## 3. Конфигурация синка

Рекомендуется хранить конфиг в репозитории, например `DOCS/ISSUE_SYNC.yml` (имя не принципиально).

Минимальные параметры:

- `workplan_path`: путь к WorkPlan  
- `repo`: owner/name (опционально, если берётся из окружения CI)  
- `labels`: mapping состояний и тегов  
- `issue_title_template`  
- `issue_body_template_version` (для управляемой миграции формата)  
- `ai_ready_criteria`: критерии, когда задача получает label `agent-ready`

---

## 4. Модель данных Task (что синк читает из WorkPlan)

Каждая задача (Task) должна быть извлечена из WorkPlan как запись со следующими полями:

### 4.1. Обязательные поля

- `task_id` — уникальный стабильный ID (у тебя: “буква + номер фазы + номер задачи”)
- `title` — краткое название
- `stage` — фаза/стейдж (группа)
- `priority` — приоритет (число или enum)
- `state` — `draft|ready|blocked|done` (минимум); расширения допускаются
- `source_ref` — якорная ссылка на конкретное место в WorkPlan (line anchor или heading anchor)

### 4.2. Опциональные поля

- `deps[]` — список `task_id`, от которых зависит задача
- `acceptance[]` — acceptance criteria
- `dod[]` — definition of done
- `constraints[]` — ограничения (например “не трогать .github”)
- `tags[]` — произвольные теги (например “docs”, “perf”, “api”)
- `notes` — краткие пояснения
- `owner_hint` — например “needs-maintainer” или “maintainer-only”

### 4.3. Ограничения на парсинг

- Парсинг должен быть устойчивым к форматированию Markdown (пробелы/пункты).
- При невозможности извлечь `task_id` задача игнорируется или помечается как “parse error” (по конфигу).

---

## 5. Каноничное отображение Task → Issue

### 5.1. Заголовок issue

Формат по умолчанию:

`[<TASK_ID>] <title>`

Пример:
`[A1-03] Implement markdown front-matter parsing`

`TASK_ID` — immutable.

### 5.2. Тело issue (каноническое)

Issue body должен быть **генерируемым** и содержать канонические секции:

1) **Task** — `TASK_ID` + ссылка на WorkPlan  
2) **Summary** — краткое описание (из WorkPlan)  
3) **Acceptance / DoD** — (если есть)  
4) **Dependencies** — список deps  
5) **Constraints** — ссылки на RFC/AGENTS/FLOW + ограничения  
6) **Verification** — ссылка на каноничные команды (EXECUTE/AGENTS)  
7) **Control** — подсказки по claim-командам и правилам изменения требований

### 5.3. “Generated header” (для защиты от ручного редактирования)

В начале managed-части issue body должен быть машинный блок-маркер:

`<!-- ISSUE_SYNC: v0.1; TASK_ID=...; WORKPLAN=... -->`

Он позволяет:
- отличать “managed issues” от ручных,
- мигрировать шаблон по версии,
- безопасно обновлять только управляемую часть.

---

## 6. Поля issue: что синк имеет право менять

### 6.1. Managed (синк владеет)

- issue title (если не отключено)
- issue body **только в секции managed** (между маркерами)
- labels, которые являются функцией Task state/ai_ready_criteria

### 6.2. Unmanaged (люди/обсуждение)

- комментарии и обсуждения
- реакции
- “ручная” секция в body, если она находится вне managed-блока
- произвольные ссылки/заметки, добавленные людьми

Рекомендуемая практика: оставить в issue body “Manual Notes” ниже managed-блока, которую синк не трогает.

---

## 7. Mapping: Task.state → Labels

Минимальный mapping (рекомендуемый):

- `draft` → `needs-maintainer` (или без меток, по вкусу)
- `ready` → (нет специальных) + если удовлетворяет ai_ready_criteria ⇒ `agent-ready`
- `blocked` → `blocked`
- `done` → (опционально) закрыть issue и/или добавить label `done`

Важно: синк не должен автоматически переводить `ready` в `agent-ready`, если нет достаточной информации (см. критерии ниже).

---

## 8. Критерии `agent-ready` (когда задачу можно отдавать автономно)

Задача получает label `agent-ready` только если выполняются все условия:

1) Есть `TASK_ID` и `title`
2) Есть явный `state=ready`
3) Есть хотя бы один из:
   - acceptance criteria
   - definition of done
   - ссылка на PRD/требования, где это описано
4) Нет блокирующих deps (все deps в состоянии `done`), либо deps отсутствуют
5) Нет `owner_hint=needs-maintainer` и нет тега `unsafe`
6) Ограничения и команды верификации доступны (есть ссылки на EXECUTE/AGENTS)

Если часть условий не выполняется, задача может быть `ready`, но **не** `agent-ready`.

---

## 9. Upsert-алгоритм (детерминированно)

Синк выполняет reconcile:

1) Спарсить WorkPlan → список Task  
2) Для каждого Task вычислить:
   - `issue_key = TASK_ID` (primary key)
   - канонический title/body/labels
3) Найти существующие issues по:
   - `TASK_ID` в title, и/или
   - маркеру `ISSUE_SYNC ... TASK_ID=...`
4) Если issue отсутствует → создать новую (если publish policy позволяет)
5) Если issue существует → обновить только managed поля при необходимости
6) Обнаружить issues, которые больше не существуют в WorkPlan:
   - по умолчанию НЕ закрывать автоматически
   - можно пометить label `orphaned` (опционально)

---

## 10. Когда создавать issue (publish policy)

Рекомендуемая политика:

- создавать issues для `ready` и `blocked`
- для `draft` — опционально (лучше не создавать, чтобы не шуметь)
- для `done` — не создавать, а существующие закрывать по merge-hook/maintainer действию

---

## 11. Правила закрытия issue

Закрытие issue должно быть проверяемым.

Каноничное правило: issue закрывается **по факту merge PR**, который привязан к `TASK_ID`.

Допускается дополнительное правило: если в WorkPlan состояние задачи изменено на `done` (через PR в репо), синк может закрыть issue, но только если в WorkPlan есть ссылка на merged PR или commit.

---

## 12. Claim и ссылки на PR

Claim — операционный факт и живёт в issue (label и/или команда).

Синк:
- не снимает claim сам
- может отображать в managed-body секцию “Status” (state, deps, PR link), если источник PR link детерминирован

Если хотите детерминированно, допускается формат-команда:
`/link-pr #123` (парсится из комментариев). Это опционально, v0.2.

---

## 13. Ошибки и диагностика

Синк обязан:

- печатать список созданных/обновлённых issues
- репортить parse errors (какие задачи не распознаны)
- fail-fast при duplicate TASK_ID

---

## 14. Безопасность

Синк запускается с минимальными правами:

- доступ к issues (read/write) и чтение репозитория
- не модифицирует code / PR / workflows
- не хранит секретов, не нужных для issues

---

## 15. Версионирование

- spec версионируется (v0.1, v0.2, …)
- шаблон issue body имеет версию (`issue_body_template_version`)
- breaking changes требуют миграционных заметок

---

## 16. Non-Goals

- конкретный код синка
- выбор конкретного инструмента (GitHub App vs Action vs локальный CLI)
- экономика вознаграждений и метрики вклада

---

## 17. Appendix: Маркеры managed/unmanaged

Рекомендуемые границы:

```
<!-- ISSUE_SYNC: begin v0.1; TASK_ID=A1-03; WORKPLAN=DOCS/Workplan.md -->
... managed content ...
<!-- ISSUE_SYNC: end -->
```

Всё ниже `end` — свободная зона для “Manual Notes” и любых ручных вставок.
